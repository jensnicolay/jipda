<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<link rel="stylesheet" href="cop.css" type="text/css" media="all"/>
	<link rel="stylesheet" href="../lib/web/jquery-ui-1.11.1/jquery-ui.min.css" type="text/css" media="all"/>  
	<link rel="stylesheet" href="../lib/web/codemirror/codemirror.css" type="text/css" media="all"/>
	<link rel="import" id="ast0src" href="../prelude.js"/>
	<link rel="import" id="ast1src" href="traits6.js"/>
	<title>COP - JIPDA</title>
	<script type="text/javascript" src="../lib/esprima.js"></script>
	<script type="text/javascript" src="../common.js"></script>
	<script type="text/javascript" src="../ast.js"></script>
	<script type="text/javascript" src="../agc.js"></script>
	<script type="text/javascript" src="../lattice.js"></script>
  <script type="text/javascript" src="../conc-lattice.js"></script>
  <script type="text/javascript" src="../conc-alloc.js"></script>
  <script type="text/javascript" src="../conc-kalloc.js"></script>
  <script type="text/javascript" src="../conc-type-lattice.js"></script>
  <script type="text/javascript" src="../tag-ctx-alloc.js"></script>
  <script type="text/javascript" src="../aac-kalloc.js"></script>
  <script type="text/javascript" src="../benv.js"></script>
  <script type="text/javascript" src="../countingStore.js"></script>
  <script type="text/javascript" src="../object.js"></script>
  <script type="text/javascript" src="../jsCesk.js"></script>
  <script type="text/javascript" src="../graph.js"></script>
	<script type="text/javascript" src="cop.js"></script>
	<script type="text/javascript" src="../lib/web/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="../lib/web/jquery-ui-1.11.1/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../lib/web/codemirror/codemirror.js"></script>
	<script type="text/javascript" src="../lib/web/codemirror/hint/show-hint.js"></script>
	<script type="text/javascript" src="../lib/web/codemirror/hint/anyword-hint.js"></script>
	<script type="text/javascript" src="../lib/web/codemirror/mode/javascript/javascript.js"></script>
	<script type="text/javascript" src="cytoscape.min.js"></script>
	<script type="text/javascript" src="dagre.min.js"></script>
	<script type="text/javascript" src="cytoscape-dagre.js"></script>
	<script type="text/javascript">
	
	"use strict";
  
  function getUrlParameter(sParam)
  {
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++)
    {
      var sParameterName = sURLVariables[i].split('=');
      if (sParameterName[0] == sParam)
      {
        return sParameterName[1];
      }
    }
  }
  
  var Editors = {};
  
  Editors.metaConfig =  function () {return {
    mode: "javascript",
    value: getUrlParameter("meta") || "",
    lineWrapping: true,
    extraKeys: { "Ctrl-Space": function (cm) {
      var word = /[\w$]+/;
      var cur = cm.getCursor(), curLine = cm.getLine(cur.line);
      var start = cur.ch, end = start;
      while (end < curLine.length && word.test(curLine.charAt(end))) ++end;
      while (start && word.test(curLine.charAt(start - 1))) --start;
      var curWord = start != end && curLine.slice(start, end);
      var startPos = CodeMirror.Pos(cur.line, start);
      var endPos = CodeMirror.Pos(cur.line, end);
      console.log(curWord);
      $.ajax({
        url : "test/resources/fun-" + curWord + ".js",
        dataType: "text",
        success : function (data) {
          console.log(data);
          cm.setValue(data) }
      })
    },
      "Ctrl-Enter": function(cm) {
        var code = $("#meta #input div.CodeMirror-code").clone().addClass("cm-s-default");
        cm.setValue("");
        cm.clearHistory();
        var out = $("#output");
        out.append(code);
        try
        {
          var txt = sanitize(code.text());
          var result = window.eval(txt);
          logOutput("result", result, function () {unhighlight(); highlight(result)});
        }
        catch (e)
        {
          logOutput("error", e + "\n" + e.stack);
        }
        var met = $("#meta");
        met.scrollTop(met[0].scrollHeight);
      }}
  }}
  
  function logOutput(clazz, msg, clickEvent)
  {
    var out = $("#output");
    out.append(function () {return $("<pre class='" + clazz + "'>" + msg + "</pre>").click(clickEvent)});
    out.scrollTop(out[0].scrollHeight);
  }
  
  
  
  var print = function () { console.log(Array.prototype.slice.call(arguments).join(" ")) }
	var editor, meta;
	var ast, astNodes;
	var system, cesk, states, transitions, graph, initial, result, contexts;
	var ag, lat, kalloc;
	
	
	  function postComputeGraph(initial)
    {
	    states = [];
      transitions = [];
      var todo = [initial];
      while (todo.length > 0)
      {
        var s = todo.pop();
        states[s._id] = s;
        s._successors = s._successors || [];
        s._successors.forEach(
         function (t)
          {
            if (isFinite(t._id))
            {
              return;
            }
            t._id = transitions.push(t) - 1;
            todo.push(t.state);
          });
        }
      }
	
	function selectErrors()
	{
	  print("here");
	  alert($('#errors'));
	  $('#errors').prop('checked', true);
	}
	
	function doIt()
	{
	  $("#eval").attr("disabled", true);
	  editor.setOption("readOnly", true);
		$("#snippet").attr("disabled", true);
		$("#config").attr("disabled", true);
    $("#errors").attr("readOnly", true);
		$("#sg").empty();
	  var src = editor.getValue();
    localStorage.protopuritySrc = src;
	  ast = Ast.createAst(src, {loc:true});
    astNodes = [];
    Ast.nodes(ast).forEach(function (n) {astNodes[n.tag] = n});
	  print(astNodes.length, "nodes in ast");
    eval($("#config").val());
    var errors = $("#errors").is(":checked");
    var gc = true;
    
    
    var ast0src = document.querySelector('link[id="ast0src"]').import.body.textContent;
    var ast1src = document.querySelector('link[id="ast1src"]').import.body.textContent;
    const initialCeskState = computeInitialCeskState(lat, concAlloc, concKalloc, ast0src, ast1src);
	  
	  logOutput("analysis", "a " + ag + ", l " + lat + ", gc " + gc + ", errors " + errors);
	  
//    var profileName = (function (date) {return date.getHours() + ":" + date.getMinutes()})(new Date());
//    console.profile(profileName);
    var start = Date.now();
    
		const cesk = jsCesk({a:ag, kalloc, l:lat, gc, errors});
		system = cesk.explore(ast, initialCeskState);


    var time = Date.now() - start;
//    console.profileEnd(profileName);
    initial = system.initial;
    result = system.result;
    contexts = system.contexts;
    console.log("analysis took " + time + " ms");
    console.log(system.states.length + " states; " + result.size + " results; " + contexts.length + " contexts");
    var result = computeResultValue(system.result);
    var resultValue = result.value;
    console.log("result value " + resultValue);
    if (errors && result.msgs.length > 0)
    {
      console.log(result.msgs.join("\n"));
      result.msgs.forEach(function (msg) {logOutput("error", msg)});
    }

    states = system.states;
    print("computing...");
    const copResult = computeContextMethods(system);
    print("done computing");


    logOutput("analysis", states.length + " time " + time);
    logOutput("result", resultValue);

    
    function methodToString(m)
    {
      return m.node.id.name;
    }
    
    function contextToString(contextObj)
    {
      return contextObj.lookup(lat.abst1("name")).value.Value.toString();
    }
    
    function GraphNode(id, name, type, object)
    {
      this.id = id;
      this.name = name;
      this.type = type;
      this.object = object;
    }
    GraphNode.nodes = [];
    GraphNode.create =
        function (name, type, object)
        {
          const existing = GraphNode.nodes.find(
              function (x)
              {
                return name === x.name
                    && type === x.type
                    && object.equals(x.object)
              });
          if (existing)
          {
            return existing;
          }
          const fresh = new GraphNode(GraphNode.nodes.length, name, type, object);
          GraphNode.nodes.push(fresh);
          return fresh;
        }
  
		const edges = copResult.flatMap(
		    function (r)
        {
          const contextName = contextToString(r.context);
          const contextNode = GraphNode.create(contextName, "context", r.context);
          const sourceName = methodToString(r.sourceMethod);
          const methodNode = GraphNode.create(sourceName, "method", r.sourceMethod);
          return [{data: {source: contextNode.id, target: methodNode.id}}]
        });
    const nodes = GraphNode.nodes.map(node => {return {data: {id:node.id, label:node.name}}});
    
    var cy = window.cy = cytoscape({
      container: document.getElementById('right'),
      
      boxSelectionEnabled: false,
      autounselectify: true,
      
      layout: {
        name: 'dagre'
      },
      
      style: [
        {
          selector: 'node',
          style: {
            'content': 'data(label)',
            'text-opacity': 0.5,
            'text-valign': 'center',
            'text-halign': 'right',
            'background-color': '#11479e'
          }
        },
        
        {
          selector: 'edge',
          style: {
            'width': 4,
            'target-arrow-shape': 'triangle',
            'line-color': '#9dbaea',
            'target-arrow-color': '#9dbaea',
            'label': 'data(label)'
          }
        }
      ],
      
      elements: {
        nodes,
        edges}
    });
    
    cy.on('tap', function(evt){
      console.log( 'tap ' + evt.target.id() );
    });
 	}
	
	
	 $(function ()
	     {
	       var srcParam = getUrlParameter("src");
	       if (srcParam)
	       {
	         $.ajax({
	           url : srcParam,
	           dataType: "text",
	           success : function (data) {
	               editor.setValue(data);
	           }
	       });
	       }
	       
	       CodeMirror.commands.autocomplete = function(cm) {
	         cm.showHint({hint: CodeMirror.hint.anyword});
	       }
	       editor = CodeMirror(document.getElementById("editor"),
	           {
	             value: localStorage.protopuritySrc || "",
	             mode: "javascript",
	             lineNumbers: true
	           });
	       meta = CodeMirror(document.getElementById("input"), Editors.metaConfig());
	       //meta.on("beforeChange", function (e, o) {if (e.getCursor().line < metaLine) {o.cancel()}}, false);
	       editor.on("dblclick", function (cm, e)
	           {
	             e.stopPropagation();
	             var pos = {left: e.pageX, top: e.pageY};
	             var editorPos = cm.coordsChar(pos, "page");
	             var astNode = editorPosToAstNode(editorPos);
	             logInput("astNodes[" + astNode.tag + "]");
	             highlightAstNodeInSource(astNode);
	             highlightAstNodeInGraph(astNode);
	           });
	       
	       $('#left').resizable({handles: 'e'});
	       
/* 	       $('#config').on('change', function (e) {
	         var optionSelected = $("option:selected", this);
	         var valueSelected = this.value;
	         alert(valueSelected);
	            }) */

				 $("#snippet").change(
				 		function ()
						{
							const srcParam = this.value;
							$.ajax({
								url : srcParam,
								dataType: "text",
								success : function (data) {
									editor.setValue(data);
								}})
						});
	       
	       if (getUrlParameter("eval"))
	       {
	         console.log("doing it");
	         setTimeout(doIt, 200);
	       }
	     })
	</script>
</head>

<body>
	<div id="left">
		<div id="editor"></div>
		<select id="snippet" title="snippet">
			<option value="">(cached)</option>
			<option value="test/resources/ms-video-encoder.js">ms-video-encoder</option>
		</select>
    <span>
      <select id="config" title="value lattice">
        <option value="(lat=new ConcTypeLattice(),ag=tagCtxAlloc,kalloc=aacKalloc)">abst</option>
        <option value="(lat=new ConcLattice(),ag=concAlloc,kalloc=concKalloc)">conc</option>
      </select>
    </span>
    <input id="errors" type="checkbox" checked="true">errors</input>
		<button id="eval" name="eval" onClick="doIt()">Eval</button>
		<div id="meta">
			<div id="output"></div>
			<div id="input"></div>
		</div>
	</div>
	<div id="right">
		<div id="graph">
		</div>
	</div>
</body>

</html>
